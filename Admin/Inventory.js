let inventory = [    { id: '123', name: 'Fresh Fish', price: 120.00, quantity: 12, stockLevel: 'low', expiration: '12-2026', dateAdded: '10-2024', image: null },    { id: '124', name: 'Chicken Breast', price: 220.00, quantity: 45, stockLevel: 'medium', expiration: '06-2025', dateAdded: '10-2024', image: null },    { id: '125', name: 'Ground Beef', price: 320.00, quantity: 78, stockLevel: 'high', expiration: '08-2025', dateAdded: '10-2024', image: null },    { id: '126', name: 'Salmon Fillet', price: 180.00, quantity: 8, stockLevel: 'low', expiration: '11-2024', dateAdded: '10-2024', image: null }];let disposalHistory = [];let currentProductImage = null;function renderInventory(items = inventory) {    const list = document.getElementById('inventoryList');    list.innerHTML = items.map((item, index) => `        <div class="table-row" style="animation-delay: ${0.9 + index * 0.1}s" onclick="openEditModal('${item.id}')">            <div class="product-image-cell">                ${item.image ? `<img src="${item.image}" alt="${item.name}">` : '<span class="material-icons">image</span>'}            </div>            <div>${item.name}</div>            <div>PHP ${Number(item.price || 0).toFixed(2)}</div>            <div>${item.id}</div>            <div>${item.quantity}</div>            <div><span class="stock-level stock-${item.stockLevel}">${item.stockLevel}</span></div>            <div>${item.expiration}</div>            <div>${item.dateAdded}</div>            <div>                <button class="delete-btn" onclick="event.stopPropagation(); deleteItem('${item.id}')">×</button>            </div>        </div>    `).join('');}function deleteItem(id) {    if (!confirm('Are you sure you want to delete this item?')) return;    (async function(){        try {            const res = await fetch(`http://localhost:3001/api/products/${encodeURIComponent(id)}`, { method: 'DELETE' });            const j = await res.json().catch(()=>null);            if (res.ok && j && j.ok) {                await refreshProducts();                alert('Product deleted');                return;            }        } catch (e) {            console.warn('Server delete failed, falling back to local delete', e);        }        inventory = inventory.filter(item => item.id !== id);        renderInventory();    })();}function openAddModal() {    document.getElementById('addModal').classList.add('active');}function openAdjustModal() {    const select = document.getElementById('adjustProductSelect');    select.innerHTML = '<option value="">Select a product</option>' +         inventory.map(item => `<option value="${item.id}">${item.name} (${item.id}) - Current: ${item.quantity}</option>`).join('');    document.getElementById('adjustModal').classList.add('active');}function openRestockModal() {    const select = document.getElementById('restockProductSelect');    select.innerHTML = '<option value="">Select a product</option>' +         inventory.map(item => `<option value="${item.id}">${item.name} (${item.id}) - Current: ${item.quantity}</option>`).join('');    document.getElementById('restockModal').classList.add('active');}function openDisposalModal() {    const select = document.getElementById('disposalProductId');    select.innerHTML = '<option value="">Select a product</option>' +         inventory.map(item => `<option value="${item.id}">${item.name} (${item.id}) - Available: ${item.quantity}</option>`).join('');    const batchSelect = document.getElementById('disposalBatchNumber');    select.onchange = async function onChange() {        const pid = this.value;        batchSelect.innerHTML = '<option value="">Select a batch</option>';        if (!pid) return;        try {            const res = await fetch(`http://localhost:3001/api/batches?productId=${encodeURIComponent(pid)}`);            const json = await res.json();            if (json && json.ok && Array.isArray(json.rows) && json.rows.length) {                json.rows.forEach(b => {                    const label = `${b.BatchId} — qty:${b.QuantityOnHand || 0}${b.Expiration ? ' — exp:' + b.Expiration : ''}`;                    batchSelect.insertAdjacentHTML('beforeend', `<option value="${b.BatchId}">${label}</option>`);                });            } else {                const prod = inventory.find(i => String(i.id) === String(pid));                if (prod && prod.batchId) batchSelect.insertAdjacentHTML('beforeend', `<option value="${prod.batchId}">${prod.batchId}</option>`);            }        } catch (e) {            console.warn('Could not fetch batches for product', e);            const prod = inventory.find(i => String(i.id) === String(pid));            if (prod && prod.batchId) batchSelect.insertAdjacentHTML('beforeend', `<option value="${prod.batchId}">${prod.batchId}</option>`);        }    };    document.getElementById('disposalModal').classList.add('active');}function closeModal() {    document.getElementById('addModal').classList.remove('active');    document.getElementById('adjustModal').classList.remove('active');    document.getElementById('restockModal').classList.remove('active');    document.getElementById('disposalModal').classList.remove('active');}function addProduct() {    const name = document.getElementById('productName').value;    const price = parseFloat(document.getElementById('productPrice').value);    const id = document.getElementById('productId').value;    const quantity = document.getElementById('productQuantity').value;    const stockLevel = document.getElementById('stockLevel').value;    const expiration = document.getElementById('expirationDate').value;    if (!name || !id || !quantity || isNaN(price)) {        alert('Please fill in all fields including a valid price');        return;    }        const performedBy = (function(){ try{ const u = JSON.parse(localStorage.getItem('currentUser')); return u && u.UserId ? u.UserId : null;}catch(e){return null;} })();    fetch('http://localhost:3001/api/inventory/add', {            method: 'POST',            headers: { 'Content-Type': 'application/json' },            body: JSON.stringify({            name,            description: '',            price: Number(price),            quantity: parseInt(quantity),            imageBase64: currentProductImage,            imageFileName: null,            performedBy: performedBy,            batchId: null,            expiration: expiration                })        }).then(r => r.json()).then(async j => {            console.log('API addProduct', j);            if (j && j.ok) {                await refreshProducts();                document.getElementById('productName').value = '';                document.getElementById('productPrice').value = '';                document.getElementById('productId').value = '';                document.getElementById('productQuantity').value = '';                document.getElementById('expirationDate').value = '';                currentProductImage = null;                resetImagePreview();                closeModal();                alert('Product added successfully!');            } else {                alert('Failed to add product: ' + (j && j.error ? j.error : 'unknown'));            }        }).catch(e => { console.warn('API not available', e); alert('Could not reach API to add product.'); });}function openEditModal(id) {    const item = inventory.find(i => String(i.id) === String(id));    if (!item) return;    document.getElementById('editProductId').value = item.id;    document.getElementById('editProductName').value = item.name || '';    document.getElementById('editProductPrice').value = item.price != null ? Number(item.price).toFixed(2) : '';    const preview = document.getElementById('editImagePreview');    if (item.image) {        preview.innerHTML = `<img src="${item.image}" alt="${item.name}">`;        preview.classList.add('has-image');    } else {        preview.innerHTML = `\n            <span class="material-icons">add_photo_alternate</span>\n            <span>Click to upload image</span>\n        `;        preview.classList.remove('has-image');    }    document.getElementById('editModal').classList.add('active');}function closeEditModal() {    document.getElementById('editModal').classList.remove('active');    document.getElementById('editProductImage').value = '';}document.getElementById('editProductImage').addEventListener('change', (e) => {    const file = e.target.files[0];    if (file) {        const reader = new FileReader();        reader.onload = (event) => {            const preview = document.getElementById('editImagePreview');            preview.innerHTML = `<img src="${event.target.result}" alt="Product Preview">`;            preview.classList.add('has-image');            document.getElementById('editModal').dataset.image = event.target.result;        };        reader.readAsDataURL(file);    }});function saveEditedProduct() {    const id = document.getElementById('editProductId').value;    const name = document.getElementById('editProductName').value;    const price = parseFloat(document.getElementById('editProductPrice').value);    const imageBase64 = document.getElementById('editModal').dataset.image || null;    if (!id || !name || isNaN(price)) {        alert('Please provide a valid name and price');        return;    }    const item = inventory.find(i => String(i.id) === String(id));    if (!item) { alert('Product not found'); return; }    item.name = name;    item.price = Number(price);    if (imageBase64) item.image = imageBase64;    renderInventory();    closeEditModal();    try {        fetch('http://localhost:3001/api/inventory/update', {            method: 'POST',            headers: { 'Content-Type': 'application/json' },            body: JSON.stringify({ productId: id, name: item.name, price: item.price, imageBase64: imageBase64 })        }).then(r => r.json()).then(j => console.log('update result', j)).catch(()=>{});    } catch(e) { }}function adjustStock() {    const id = document.getElementById('adjustProductSelect').value;    const quantity = parseInt(document.getElementById('adjustQuantity').value);    const stockLevel = document.getElementById('adjustStockLevel').value;    const adjustmentType = document.getElementById('adjustmentType').value;    if (!id) {        alert('Please select a product');        return;    }    if (!quantity || quantity <= 0) {        alert('Please enter a valid quantity');        return;    }    const item = inventory.find(i => i.id === id);    if (item) {        if (adjustmentType === 'add') {            item.quantity += quantity;        } else if (adjustmentType === 'subtract') {            item.quantity = Math.max(0, item.quantity - quantity);        } else if (adjustmentType === 'set') {            item.quantity = quantity;        }        if (stockLevel) {            item.stockLevel = stockLevel;        }        renderInventory();        closeModal();        document.getElementById('adjustQuantity').value = '';        alert('Stock adjusted successfully!');        fetch('http://localhost:3001/api/inventory/adjust', {            method: 'POST',            headers: { 'Content-Type': 'application/json' },        body: JSON.stringify({ productId: id, adjustmentType: adjustmentType, quantity: parseInt(quantity), stockLevel, performedBy: (function(){ try{ const u = JSON.parse(localStorage.getItem('currentUser')); return u && u.UserId ? u.UserId : null;}catch(e){return null;} })() })        }).then(r => r.json()).then(async j => {            console.log('API adjustStock', j);            if (j && j.ok) {                await refreshProducts();            }        }).catch(e => console.warn('API not available', e));    }}async function restockProduct() {    console.log('restockProduct() called');    const btn = document.getElementById('restockBtn');    if (btn && btn.dataset.inprogress === '1') {        console.log('restock already in progress, ignoring duplicate click');        return;    }    if (btn) {        btn.dataset.inprogress = '1';        btn.disabled = true;        const oldText = btn.textContent;        btn.dataset._oldText = oldText;        btn.textContent = 'Restocking...';        const t = setTimeout(() => {            try {                btn.dataset.inprogress = '0';                btn.disabled = false;                btn.textContent = btn.dataset._oldText || 'Restock';                delete btn.dataset._oldText;            } catch(e){}        }, 12000);        btn.dataset._timer = t;    }    const id = document.getElementById('restockProductSelect').value;    const quantity = parseInt(document.getElementById('restockQuantity').value);    const expiration = document.getElementById('restockExpiration').value;    if (!id) {        alert('Please select a product');        return;    }    if (!quantity || quantity <= 0) {        alert('Please enter a valid quantity');        return;    }    const item = inventory.find(i => i.id === id);    if (item) {        item.quantity += quantity;        if (expiration && expiration.trim()) {            item.expiration = expiration;        }        if (item.quantity < 20) {            item.stockLevel = 'low';        } else if (item.quantity < 50) {            item.stockLevel = 'medium';        } else {            item.stockLevel = 'high';        }        renderInventory();        closeModal();        document.getElementById('restockQuantity').value = '';        document.getElementById('restockExpiration').value = '';        alert(`Successfully restocked ${quantity} units of ${item.name}`);        const performedBy = (function(){ try{ const u = JSON.parse(localStorage.getItem('currentUser')); return u && u.UserId ? u.UserId : null;}catch(e){return null;} })();        try {            const res = await fetch('http://localhost:3001/api/inventory/restock', {                method: 'POST',                headers: { 'Content-Type': 'application/json' },                body: JSON.stringify({ productId: id, quantity: parseInt(quantity), expiration: expiration, performedBy: performedBy, batchId: null })            });            const j = await res.json().catch(()=>null);            console.log('API restock', j || res.status);            if (j && j.ok) {                await refreshProducts();            } else if (!j) {                console.warn('Restock response not JSON', res.status);            }        } catch (e) {            console.warn('API not available', e);            alert('Could not reach API to restock product.');        } finally {            console.log('restockProduct() finally block executing');            if (btn) {                btn.dataset.inprogress = '0';                btn.disabled = false;                btn.textContent = btn.dataset._oldText || 'Restock';                try { delete btn.dataset._oldText; } catch(e){}                if (btn.dataset._timer) {                    clearTimeout(btn.dataset._timer);                    delete btn.dataset._timer;                }            }        }    }}function disposeProduct() {    const id = document.getElementById('disposalProductId').value;    const batchNumber = document.getElementById('disposalBatchNumber').value;    const quantity = parseInt(document.getElementById('disposalQuantity').value);    const reason = document.getElementById('disposalReason').value;    const otherReason = document.getElementById('disposalOtherReason').value;    const notes = document.getElementById('disposalNotes').value;    if (!id) { alert('Please select a product'); return; }    if (!batchNumber || !batchNumber.trim()) { alert('Please enter a batch number'); return; }    if (!quantity || quantity <= 0) { alert('Please enter a valid quantity to dispose'); return; }    const item = inventory.find(i => i.id === id);    if (!item) { alert('Product not found'); return; }    if (quantity > item.quantity) { alert(`Cannot dispose ${quantity} units. Only ${item.quantity} available.`); return; }    const disposalRecord = {        productId: id,        productName: item.name,        batchNumber: batchNumber,        quantity: quantity,        reason: reason === 'other' ? otherReason : reason,        notes: notes,        date: new Date().toLocaleDateString(),        timestamp: new Date().toISOString()    };    const performedBy = (function(){ try{ const u = JSON.parse(localStorage.getItem('currentUser')); return u && u.UserId ? u.UserId : null;}catch(e){return null;} })();    fetch('http://localhost:3001/api/inventory/dispose', {        method: 'POST',        headers: { 'Content-Type': 'application/json' },        body: JSON.stringify({ productId: id, batchId: batchNumber, quantity: quantity, reason: disposalRecord.reason, notes: notes, performedBy: performedBy })    }).then(r => r.json()).then(async j => {        console.log('API dispose', j);        if (j && j.ok) {            disposalHistory.push(disposalRecord);            await refreshProducts();            document.getElementById('disposalBatchNumber').value = '';            document.getElementById('disposalQuantity').value = '';            document.getElementById('disposalReason').value = '';            document.getElementById('disposalOtherReason').value = '';            document.getElementById('disposalNotes').value = '';            closeModal();            alert(`Successfully disposed ${quantity} units of ${item.name}\nBatch: ${batchNumber}\nReason: ${disposalRecord.reason}`);            console.log('Disposal History:', disposalHistory);        } else {            alert('Failed to dispose product: ' + (j && j.error ? j.error : 'unknown'));        }    }).catch(e => { console.warn('API not available', e); alert('Could not reach API to dispose product.'); });}const navMap = {    'Dashboard': '../Home Page/index.html',    'User': 'User.html',    'Orders': 'Orders.html',    'Analytics': 'Analytics.html',    'Inventory': 'Inventory.html',    'History': 'History.html',    'Settings': 'Settings.html'};document.querySelectorAll('.nav-item').forEach(item => {    item.addEventListener('click', function () {        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));        this.classList.add('active');        const label = this.textContent.trim();        const target = navMap[label];        if (target) window.location.href = target;    });});function sendAudit(performedBy, actionType, details) {    fetch('http://localhost:3001/api/audit', {        method: 'POST',        headers: { 'Content-Type': 'application/json' },        body: JSON.stringify({ performedBy: performedBy || null, actionType, details })    }).then(r => r.json()).then(j => console.log('Audit:', j)).catch(e => {});}document.getElementById('searchInput').addEventListener('input', (e) => {    const search = e.target.value.toLowerCase();    const filtered = inventory.filter(item =>         item.name.toLowerCase().includes(search) ||        item.id.toLowerCase().includes(search)    );    renderInventory(filtered);});document.getElementById('disposalReason').addEventListener('change', (e) => {    const otherReasonGroup = document.getElementById('otherReasonGroup');    if (e.target.value === 'other') {        otherReasonGroup.style.display = 'block';    } else {        otherReasonGroup.style.display = 'none';    }});document.getElementById('productImage').addEventListener('change', (e) => {    const file = e.target.files[0];    if (file) {        const reader = new FileReader();        reader.onload = (event) => {            currentProductImage = event.target.result;            const preview = document.getElementById('imagePreview');            preview.innerHTML = `<img src="${event.target.result}" alt="Product Preview">`;            preview.classList.add('has-image');        };        reader.readAsDataURL(file);    }});function resetImagePreview() {    const preview = document.getElementById('imagePreview');    preview.innerHTML = `        <span class="material-icons">add_photo_alternate</span>        <span>Click to upload image</span>    `;    preview.classList.remove('has-image');    document.getElementById('productImage').value = '';}document.querySelectorAll('.modal').forEach(modal => {    modal.addEventListener('click', (e) => {        if (e.target === modal) {            closeModal();        }    });});(async function initInventory() {    try {        const res = await fetch('http://localhost:3001/api/products');        const json = await res.json();        if (json && json.ok && Array.isArray(json.rows)) {            inventory = json.rows.map(p => ({            id: String(p.ProductId),            name: p.Name || 'Product',            price: typeof p.Price !== 'undefined' && p.Price !== null ? Number(p.Price) : 0,            quantity: p.QuantityOnHand || 0,            stockLevel: (p.QuantityOnHand < 20) ? 'low' : (p.QuantityOnHand < 50) ? 'medium' : 'high',            expiration: p.Expiration || null,            batchId: p.BatchId || null,                dateAdded: p.CreatedAt ? new Date(p.CreatedAt).toLocaleDateString() : '',                image: p.ImageData || null            }));            renderInventory(inventory);            return;        }    } catch (e) {        console.warn('Products API not available', e);    }    renderInventory();})();async function refreshProducts() {    try {        const res = await fetch('http://localhost:3001/api/products');        const json = await res.json();        if (json && json.ok && Array.isArray(json.rows)) {            inventory = json.rows.map(p => ({                id: String(p.ProductId),                name: p.Name || 'Product',                price: typeof p.Price !== 'undefined' && p.Price !== null ? Number(p.Price) : 0,                quantity: p.QuantityOnHand || 0,                stockLevel: (p.QuantityOnHand < 20) ? 'low' : (p.QuantityOnHand < 50) ? 'medium' : 'high',                expiration: p.Expiration || null,                batchId: p.BatchId || null,                dateAdded: p.CreatedAt ? new Date(p.CreatedAt).toLocaleDateString() : '',                image: p.ImageData || null            }));            renderInventory(inventory);            return true;        }    } catch (e) {        console.warn('Products API not available when refreshing', e);    }    return false;}
