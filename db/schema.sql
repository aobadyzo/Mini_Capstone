IF NOT EXISTS(SELECT * FROM sys.databases WHERE name = N'INVENTORY_SYSTEM_DB')BEGIN    CREATE DATABASE INVENTORY_SYSTEM_DB;    PRINT 'Database INVENTORY_SYSTEM_DB created.';ENDGOUSE INVENTORY_SYSTEM_DB;GOCREATE TABLE dbo.Users (    UserId INT IDENTITY(1,1) PRIMARY KEY,    Username NVARCHAR(100) NOT NULL UNIQUE,    Email NVARCHAR(255) NOT NULL UNIQUE,    PasswordHash NVARCHAR(512) NOT NULL,    FullName NVARCHAR(255) NULL,    Role NVARCHAR(50) NOT NULL DEFAULT 'user',    CreatedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),    IsActive BIT NOT NULL DEFAULT 1);CREATE TABLE dbo.Products (    ProductId INT IDENTITY(1,1) PRIMARY KEY,    Name NVARCHAR(255) NOT NULL,    Description NVARCHAR(MAX) NULL,    Price DECIMAL(18,2) NOT NULL DEFAULT(0.00),    QuantityOnHand INT NOT NULL DEFAULT 0,    Expiration NVARCHAR(50) NULL,    ReorderLevel INT NOT NULL DEFAULT 0,    CreatedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),    UpdatedAt DATETIME2 NULL);CREATE TABLE dbo.ProductImages (    ImageId INT IDENTITY(1,1) PRIMARY KEY,    ProductId INT NOT NULL REFERENCES dbo.Products(ProductId) ON DELETE CASCADE,    FileName NVARCHAR(260) NULL,    ContentType NVARCHAR(100) NULL,    ImageData VARBINARY(MAX) NULL,    FilePath NVARCHAR(500) NULL,    IsPrimary BIT NOT NULL DEFAULT 0,    CreatedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME());CREATE INDEX IX_ProductImages_ProductId ON dbo.ProductImages(ProductId);CREATE TABLE dbo.Orders (    OrderId INT IDENTITY(1,1) PRIMARY KEY,    UserId INT NULL REFERENCES dbo.Users(UserId),    OrderNumber NVARCHAR(50) NOT NULL UNIQUE,    OrderStatus NVARCHAR(50) NOT NULL DEFAULT 'Pending',    ReferenceNumber NVARCHAR(255) NULL,    ReferenceImage VARBINARY(MAX) NULL,    PickupDate DATETIME2 NULL,    TotalAmount DECIMAL(18,2) NOT NULL DEFAULT 0.00,    PlacedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),    UpdatedAt DATETIME2 NULL);CREATE TABLE dbo.OrderItems (    OrderItemId INT IDENTITY(1,1) PRIMARY KEY,    OrderId INT NOT NULL REFERENCES dbo.Orders(OrderId) ON DELETE CASCADE,    ProductId INT NOT NULL REFERENCES dbo.Products(ProductId),    Quantity INT NOT NULL DEFAULT 1,    UnitPrice DECIMAL(18,2) NOT NULL,    LineTotal AS (Quantity * UnitPrice) PERSISTED);CREATE INDEX IX_OrderItems_OrderId ON dbo.OrderItems(OrderId);CREATE TABLE dbo.InventoryHistory (    HistoryId INT IDENTITY(1,1) PRIMARY KEY,    ProductId INT NOT NULL REFERENCES dbo.Products(ProductId),    PerformedByUserId INT NULL REFERENCES dbo.Users(UserId),    BatchId NVARCHAR(100) NULL,    Expiration NVARCHAR(50) NOT NULL DEFAULT(''),    ActionType NVARCHAR(50) NOT NULL CONSTRAINT CK_InventoryHistory_ActionType CHECK (ActionType IN ('StockAdjustment','AddProduct','Restock','DisposedProduct','ArchivedProduct')),    QuantityChange INT NOT NULL,    Note NVARCHAR(1000) NULL,    CreatedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME());CREATE INDEX IX_InventoryHistory_ProductId ON dbo.InventoryHistory(ProductId);CREATE INDEX IX_InventoryHistory_PerformedBy ON dbo.InventoryHistory(PerformedByUserId);CREATE TABLE dbo.AuditLogs (    AuditLogId INT IDENTITY(1,1) PRIMARY KEY,    PerformedByUserId INT NULL REFERENCES dbo.Users(UserId),    ActionType NVARCHAR(100) NOT NULL CONSTRAINT CK_AuditLogs_ActionType CHECK (ActionType IN ('AddUser','EditUser','ChangedPassword','DeleteUser','Login','Logout')),    Details NVARCHAR(MAX) NULL,    EventTime DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME());CREATE INDEX IX_AuditLogs_PerformedBy ON dbo.AuditLogs(PerformedByUserId);CREATE TABLE dbo.TransactionLogs (    TransactionLogId INT IDENTITY(1,1) PRIMARY KEY,    OrderId INT NOT NULL REFERENCES dbo.Orders(OrderId) ON DELETE CASCADE,    ProcessedByUserId INT NULL REFERENCES dbo.Users(UserId),    PaymentMethod NVARCHAR(100) NOT NULL, -- e.g., 'Cash','Card','Online'    AmountPaid DECIMAL(18,2) NOT NULL,    TransactionDate DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),    Notes NVARCHAR(MAX) NULL);CREATE INDEX IX_TransactionLogs_OrderId ON dbo.TransactionLogs(OrderId);CREATE INDEX IX_TransactionLogs_ProcessedBy ON dbo.TransactionLogs(ProcessedByUserId);CREATE TABLE dbo.AnalyticsEvents (    EventId INT IDENTITY(1,1) PRIMARY KEY,    EventType NVARCHAR(100) NOT NULL,    UserId INT NULL REFERENCES dbo.Users(UserId),    Metadata NVARCHAR(MAX) NULL, -- JSON if you want to store structured data    EventTime DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME());CREATE INDEX IX_AnalyticsEvents_EventType ON dbo.AnalyticsEvents(EventType);GOIF OBJECT_ID('dbo.v_ProductWithPrimaryImage', 'V') IS NOT NULL    DROP VIEW dbo.v_ProductWithPrimaryImage;GOCREATE VIEW dbo.v_ProductWithPrimaryImageASSELECT p.ProductId, p.Name, p.Description, p.Price, p.QuantityOnHand,    pi.ImageId, pi.FileName, pi.ContentType, pi.FilePath, pi.IsPrimaryFROM dbo.Products pLEFT JOIN dbo.ProductImages pi    ON p.ProductId = pi.ProductId AND pi.IsPrimary = 1;GOIF OBJECT_ID('dbo.AddProductWithImage', 'P') IS NOT NULL    DROP PROCEDURE dbo.AddProductWithImage;GOCREATE PROCEDURE dbo.AddProductWithImage    @Name NVARCHAR(255),    @Description NVARCHAR(MAX) = NULL,    @Price DECIMAL(18,2) = 0.00,    @QuantityOnHand INT = 0,    @ImageFileName NVARCHAR(260) = NULL,    @ImageContentType NVARCHAR(100) = NULL,    @ImageData VARBINARY(MAX) = NULL -- if NULL, no binary savedASBEGIN    SET NOCOUNT ON;    BEGIN TRY    INSERT INTO dbo.Products (Name, Description, Price, QuantityOnHand, CreatedAt)    VALUES (@Name, @Description, @Price, @QuantityOnHand, SYSUTCDATETIME());        DECLARE @ProductId INT = SCOPE_IDENTITY();        IF @ImageData IS NOT NULL OR @ImageFileName IS NOT NULL        BEGIN            INSERT INTO dbo.ProductImages (ProductId, FileName, ContentType, ImageData, FilePath, IsPrimary)            VALUES (@ProductId, @ImageFileName, @ImageContentType, @ImageData, NULL, 1);        END        SELECT @ProductId AS ProductId;    END TRY    BEGIN CATCH        THROW;    END CATCHEND;GO
